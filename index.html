<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Prescribing Dataset (EPD) ‚Äî Explorer (demo)</title>
  <style>
    /* Simple responsive UI adapted from indexb.html */
    :root {
      --bg: #f4f4f7;
      --panel: #ffffff;
      --border: #dde1eb;
      --accent: #005eb8;
      --radius: 10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: var(--bg);
      color: #111827;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.35;
    }
    header {
      background: linear-gradient(135deg, var(--accent), #003f88);
      color: white;
      padding: 1rem;
    }
    .header-inner { max-width: 1100px; margin: 0 auto; }
    main { max-width: 1100px; margin: 1rem auto; padding: 0 1rem; }
    .layout { display: grid; grid-template-columns: minmax(260px, 340px) 1fr; gap: 1rem; align-items: start; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    .panel { background: var(--panel); border-radius: 10px; padding: 1rem; border: 1px solid var(--border); }
    .form-group { margin-bottom: 0.8rem; }
    label { display:block; font-weight:600; margin-bottom:0.25rem; font-size:0.95rem; }
    .help-text { color:#6b7280; font-size:0.85rem; margin-top:0.25rem; }
    input[type="text"], select { width:100%; padding:0.5rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.95rem; }
    button.primary { background:var(--accent); color:white; border:none; padding:0.55rem 0.8rem; border-radius:6px; cursor:pointer; }
    button.secondary { background:#eef5ff; color:var(--accent); border:1px solid rgba(0,94,184,0.12); padding:0.4rem 0.6rem; border-radius:6px; cursor:pointer; }
    .inline-checkbox { display:flex; align-items:center; gap:0.4rem; }
    .hidden { display:none; }
    #resultsArea { min-height:120px; }
    table { width:100%; border-collapse:collapse; margin-top:0.6rem; font-size:0.9rem; }
    th, td { padding:0.45rem 0.6rem; border-bottom:1px solid #eef2f7; text-align:left; }
    th { background:#fbfdff; font-weight:700; }
    .summary-line { margin:0.25rem 0; font-size:0.95rem; }
    footer { max-width:1100px; margin: 1rem auto; padding:0 1rem 2rem; color:#6b7280; font-size:0.85rem; }
    .muted { color:#6b7280; font-size:0.9rem; }
    .button-row { display:flex; gap:0.6rem; align-items:center; margin-top:0.6rem; }
    .spacer { flex:1; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1 style="margin:0;font-size:1.25rem;">English Prescribing Dataset (EPD) ‚Äî Explorer (demo)</h1>
      <p style="margin:0.4rem 0 0;" class="muted">Demo copy ‚Äî this page contains a local mock fetch implementation so it can run standalone. Replace the mock fetch with your NHSBSA/Open Data API cal[...]
    </div>
  </header>

  <main>
    <div class="layout">
      <section class="panel" aria-labelledby="search-heading">
        <h2 id="search-heading">Search parameters</h2>

        <form id="searchForm">
          <div class="form-group">
            <label for="searchMode">Search by</label>
            <select id="searchMode" aria-label="Search mode">
              <option value="presentation">BNF presentation name</option>
              <option value="bnf_code">BNF code (BNF_CODE)</option>
            </select>
            <div class="help-text">Choose whether you're searching by presentation text or the BNF code.</div>
          </div>

          <div class="form-group">
            <label for="drugQuery">Drug name (or BNF code)</label>
            <input type="text" id="drugQuery" name="drugQuery" required autocomplete="off" value="Lorazepam 250microgram tablets" />
            <div class="help-text">Full BNF presentation text as in the dataset, e.g. <code style="font-family:var(--mono);font-size:0.85rem;">Lorazepam 250microgram tablets</code>.</div>
          </div>

          <div style="display:flex; gap:0.6rem; align-items:center; margin-bottom:0.8rem;">
            <div style="flex:1;">
              <div class="inline-checkbox" style="margin:0;">
                <input type="checkbox" id="exactMatch" checked />
                <label for="exactMatch" style="margin:0;font-weight:400;">Exact match</label>
              </div>
            </div>
            <div>
              <button type="button" class="secondary" id="lookupBnfButton" title="Find matching BNF codes/presentations">üîé Lookup</button>
            </div>
          </div>

          <div class="form-group">
            <label>Month range</label>
            <div style="display:flex; gap:0.4rem;">
              <div style="flex:1;">
                <select id="startMonth"></select>
                <div class="help-text">Start</div>
              </div>
              <div style="flex:1;">
                <select id="endMonth"></select>
                <div class="help-text">End</div>
              </div>
            </div>
          </div>

          <div class="button-row">
            <button type="submit" class="primary" id="runButton"><span>Run query</span></button>
            <button type="button" class="secondary" id="downloadCsvButton" title="Download aggregated results as CSV" disabled>‚¨áÔ∏è Download CSV</button>
            <div class="spacer"></div>
            <small class="muted">Download CSV will export the aggregated practice-month rows shown in the table.</small>
          </div>
        </form>
      </section>

      <section id="resultsArea" class="panel hidden" aria-live="polite">
        <h2 id="resultsTitle">Results</h2>
        <div id="resultsStats" class="help-text"></div>
        <div id="summaryArea"></div>

        <div id="presentationChoice" class="hidden" style="margin-top:0.6rem;">
          <label for="presentationSelect">Presentation:</label>
          <select id="presentationSelect"></select>
        </div>

        <div id="tableContainer"></div>
      </section>
    </div>
  </main>

  <footer>
    <small>EPD Explorer ‚Äî demo page. Replace the mock fetch implementation with your real fetchDrugDataForResource to use NHSBSA Open Data.</small>
  </footer>

  <script>
    // Minimal DOM helper
    const $ = id => document.getElementById(id);

    // State
    let monthsIndex = []; // array of { yearMonth, resourceId }
    let rawRecords = [];
    let aggregated = [];

    // Utilities
    function setStatus(msg = "", opts = {}) {
      $("resultsStats").textContent = msg || "";
      if (opts.error) console.error(msg);
      if (opts.loading) console.info(msg);
    }
    function setFormEnabled(enabled) {
      $("runButton").disabled = !enabled;
      $("lookupBnfButton").disabled = !enabled;
      $("drugQuery").disabled = !enabled;
      $("searchMode").disabled = !enabled;
      $("exactMatch").disabled = !enabled;
      $("startMonth").disabled = !enabled;
      $("endMonth").disabled = !enabled;
      // during queries this may be disabled; otherwise enable/disable based on whether there is data
      if (!enabled) {
        $("downloadCsvButton").disabled = true;
      } else {
        $("downloadCsvButton").disabled = !(aggregated && aggregated.length);
      }
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    // --- Demo months init: populate last 18 months as demo (unchanged) ---
    function initMonthsDemo() {
      const now = new Date();
      const months = [];
      for (let i = 0; i < 18; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const ym = d.toISOString().slice(0,7); // YYYY-MM
        // resourceId: keep as YYYY-MM (fetch will build CSV URL from template)
        months.push({ yearMonth: ym, resourceId: ym });
      }
      monthsIndex = months.reverse(); // ascending
      const startSel = $("startMonth");
      const endSel = $("endMonth");
      startSel.innerHTML = "";
      endSel.innerHTML = "";
      monthsIndex.forEach(m => {
        const o1 = document.createElement("option");
        o1.value = m.yearMonth; o1.textContent = m.yearMonth;
        startSel.appendChild(o1);
        const o2 = document.createElement("option");
        o2.value = m.yearMonth; o2.textContent = m.yearMonth;
        endSel.appendChild(o2);
      });
      // default: last 6 months
      if (monthsIndex.length) {
        startSel.value = monthsIndex[Math.max(0, monthsIndex.length - 6)].yearMonth;
        endSel.value = monthsIndex[monthsIndex.length - 1].yearMonth;
      }
    }

    // Utility: simple CSV parser that supports quoted fields and newlines inside quotes.
    function parseCSV(text) {
      if (!text) return [];
      const rows = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"') {
          if (inQuotes && next === '"') {
            cur += '"'; i++; // escaped quote
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === '\n' && !inQuotes) {
          rows.push(cur.replace(/\r$/, '')); cur = '';
        } else {
          cur += ch;
        }
      }
      if (cur.length) rows.push(cur.replace(/\r$/, ''));
      if (!rows.length) return [];

      // split each row into fields (handles quoted fields)
      const parsed = rows.map(line => {
        const fields = [];
        let cell = '';
        let q = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          const next = line[i+1];
          if (ch === '"') {
            if (q && next === '"') { cell += '"'; i++; }
            else q = !q;
          } else if (ch === ',' && !q) {
            fields.push(cell); cell = '';
          } else {
            cell += ch;
          }
        }
        fields.push(cell);
        return fields;
      });

      const headers = parsed[0].map(h => h.trim());
      const objs = [];
      for (let r = 1; r < parsed.length; r++) {
        const arr = parsed[r];
        // skip empty lines
        if (arr.length === 1 && arr[0] === '') continue;
        const obj = {};
        for (let c = 0; c < headers.length; c++) {
          obj[headers[c]] = arr[c] !== undefined ? arr[c] : '';
        }
        objs.push(obj);
      }
      return objs;
    }

    // Helper: map a source row (from NHSBSA CSV) to the app's expected record shape
    function normalizeRow(src, yearMonth) {
      // Common column names from NHSBSA monthly prescribing CSVs vary; try multiple possibilities
      const col = (names) => {
        for (const n of names) {
          if (n in src && src[n] !== undefined) return src[n];
        }
        return '';
      };

      const practiceCode = col(['PRACTICE', 'PRACTICE_CODE', 'practice', 'Practice', 'PracticeCode']);
      const practiceName = col(['PRACTICE_NAME','NAME','PracticeName','PRACTICE_NAME ']);
      const bnfPresentation = col(['BNF_PRESENTATION','BNF_PRESENTATION_NAME','BNF_DESCRIPTION','Presentation','Presentation_Name']);
      const bnfCode = col(['BNF_CODE','bnf_code','BNF_CODE ']);
      const items = col(['ITEMS','Items','Total Items','TotalItems','items']) || '0';
      const qty = col(['QUANTITY','QUANT','QTY','Quantity','Total Quantity','TotalQuantity']) || '0';
      const net = col(['NET_COST','NET_COST (¬£)','NetCost','NET_COST_','Net_Cost']) || '0';

      return {
        PRACTICE_CODE: String(practiceCode).trim(),
        PRACTICE_NAME: String(practiceName || '').trim(),
        BNF_PRESENTATION_NAME: String(bnfPresentation || '').trim(),
        BNF_CODE: String(bnfCode || '').trim(),
        ITEMS: Number(String(items).replace(/[^0-9\.-]/g, '')) || 0,
        QTY: Number(String(qty).replace(/[^0-9\.-]/g, '')) || 0,
        NET_COST: Number(String(net).replace(/[^0-9\.-]/g, '')) || 0,
        YEAR_MONTH: yearMonth
      };
    }

    // --- Real fetch: fetch CSV from NHSBSA monthly file or a direct CSV URL ---
    // Configuration: set a template URL here (or set window.NHSBSA_CSV_BASE_URL externally)
    // The template must include either {YYYYMM} (e.g. 202407) or {YYYY-MM} (e.g. 2024-07)
    // Example (you must set this to your real NHSBSA CSV pattern):
    // window.NHSBSA_CSV_BASE_URL = "https://example.bucket.host/prescribing_{YYYYMM}.csv";
    // Or provide monthsIndex entries that are full http(s) URLs and those will be fetched directly.
    window.NHSBSA_CSV_BASE_URL = window.NHSBSA_CSV_BASE_URL || ""; // <-- configure this!

    async function fetchDrugDataForResource(resourceId, queryText, exactMatch = true, mode = "presentation") {
      // If resourceId begins with "demo-" keep demo behaviour (so the demo still works)
      if (typeof resourceId === 'string' && resourceId.startsWith('demo-')) {
        // fallback to previous demo implementation (small synthetic dataset)
        // reuse the previous simple generator for demo resources
        await sleep(120);
        const ym = resourceId.includes('demo-') ? `${resourceId.slice(5,9)}-${resourceId.slice(9,11)}` : resourceId;
        const baseNames = [
          "Lorazepam 250microgram tablets",
          "Lorazepam 500microgram tablets",
          "Diazepam 2mg tablets"
        ];
        const q = (queryText || "").toLowerCase();
        const matches = baseNames.filter(n => {
          if (exactMatch) return n.toLowerCase() === q;
          return n.toLowerCase().includes(q);
        });
        if (!matches.length) return [];
        const practices = [
          { code: "A10001", name: "Springfield Surgery" },
          { code: "A10002", name: "Riverside Medical" },
          { code: "A10003", name: "Hilltop Clinic" }
        ];
        const rows = [];
        for (const p of practices) {
          for (const name of matches) {
            const seed = (name.length + p.code.length + ym.length) % 10;
            const items = 10 + seed * 7;
            const qty = items * (1 + (seed % 3));
            const net = Number((items * (1.25 + (seed * 0.12))).toFixed(2));
            rows.push({
              PRACTICE_CODE: p.code,
              PRACTICE_NAME: p.name,
              BNF_PRESENTATION_NAME: name,
              ITEMS: items,
              QTY: qty,
              NET_COST: net,
              YEAR_MONTH: ym
            });
          }
        }
        return rows;
      }

      // Build CSV URL
      let csvUrl = null;
      if (/^https?:\/\//i.test(resourceId)) {
        csvUrl = resourceId;
      } else {
        // expect resourceId to be a year-month "YYYY-MM" (as produced by initMonthsDemo)
        const ym = String(resourceId);
        const yyyymm = ym.replace('-', '');
        const template = window.NHSBSA_CSV_BASE_URL || "";
        if (!template) {
          throw new Error('NHSBSA CSV base URL is not configured. Set window.NHSBSA_CSV_BASE_URL to a template containing {YYYYMM} or {YYYY-MM}.');
        }
        if (template.includes('{YYYYMM}')) csvUrl = template.replace(/\{YYYYMM\}/g, yyyymm);
        else csvUrl = template.replace(/\{YYYY-MM\}/g, ym);
      }

      // Fetch CSV
      let resp;
      try {
        resp = await fetch(csvUrl);
      } catch (err) {
        throw new Error(`Network error fetching CSV ${csvUrl}: ${err && err.message ? err.message : String(err)}`);
      }
      if (!resp.ok) {
        throw new Error(`Failed to fetch CSV ${csvUrl}: HTTP ${resp.status}`);
      }
      const text = await resp.text();
      const parsed = parseCSV(text); // array of objects (header->value)
      const yearMonth = (resourceId && String(resourceId).includes('-')) ? String(resourceId) : (resourceId || '');

      // Normalize rows
      const normalized = parsed.map(r => normalizeRow(r, yearMonth));

      // Filtering: by BNF presentation or by BNF code
      const q = (queryText || '').trim();
      if (!q) return [];

      let filtered = [];
      if (mode === 'bnf_code') {
        const qUp = q.toUpperCase();
        filtered = normalized.filter(r => {
          const code = (r.BNF_CODE || '').toUpperCase();
          if (exactMatch) return code === qUp;
          return code.includes(qUp) || (r.BNF_PRESENTATION_NAME || '').toLowerCase().includes(q.toLowerCase());
        });
      } else {
        const qLower = q.toLowerCase();
        filtered = normalized.filter(r => {
          const name = (r.BNF_PRESENTATION_NAME || '').toLowerCase();
          if (exactMatch) return name === qLower;
          return name.includes(qLower);
        });
      }

      return filtered;
    }

    // Normalization wrapper (handles Array or {records, error})
    async function normalizedFetchDrugDataForResource(resourceId, queryText, exactMatch, mode = "presentation") {
      try {
        const res = await fetchDrugDataForResource(resourceId, queryText, exactMatch, mode);
        if (Array.isArray(res)) return { records: res, error: null };
        if (res && Array.isArray(res.records)) return { records: res.records, error: res.error || null };
        if (res && Array.isArray(res.data)) return { records: res.data, error: res.error || null };
        return { records: [], error: (res && res.error) || null };
      } catch (err) {
        return { records: [], error: err && err.message ? err.message : String(err) };
      }
    }

    // Aggregate by practice + month
    function aggregateByPracticeMonth(records) {
      const map = new Map();
      for (const r of records) {
        const key = `${r.PRACTICE_CODE}||${r.YEAR_MONTH}`;
        const existing = map.get(key) || {
          PRACTICE_CODE: r.PRACTICE_CODE,
          PRACTICE_NAME: r.PRACTICE_NAME || "",
          YEAR_MONTH: r.YEAR_MONTH,
          ITEMS: 0, QTY: 0, NET_COST: 0
        };
        existing.ITEMS += Number(r.ITEMS || 0);
        existing.QTY += Number(r.QTY || 0);
        existing.NET_COST += Number(r.NET_COST || 0);
        map.set(key, existing);
      }
      return Array.from(map.values()).sort((a,b) => {
        if (a.PRACTICE_NAME < b.PRACTICE_NAME) return -1;
        if (a.PRACTICE_NAME > b.PRACTICE_NAME) return 1;
        return a.YEAR_MONTH.localeCompare(b.YEAR_MONTH);
      });
    }

    // Render table
    function renderTable(rows) {
      const container = $("tableContainer");
      if (!rows || !rows.length) {
        container.innerHTML = "<p class='muted'>No rows to display.</p>";
        $("downloadCsvButton").disabled = true;
        return;
      }
      let html = `<div class="help-text summary-line"><strong>Showing ${rows.length} aggregated rows</strong></div>`;
      html += `<table aria-describedby="resultsTitle"><thead><tr><th>Practice</th><th>Month</th><th style="text-align:right">Items</th><th style="text-align:right">Qty</th><th style="text-align:right">Cost</th></tr></thead><tbody>`;
      for (const r of rows) {
        html += `<tr>
          <td>${escapeHtml(r.PRACTICE_NAME)} <small class="muted">(${escapeHtml(r.PRACTICE_CODE)})</small></td>
          <td>${escapeHtml(r.YEAR_MONTH)}</td>
          <td style="text-align:right">${Number(r.ITEMS).toLocaleString()}</td>
          <td style="text-align:right">${Number(r.QTY).toLocaleString()}</td>
          <td style="text-align:right">¬£${Number(r.NET_COST).toFixed(2)}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      container.innerHTML = html;
      // enable download if there's data
      $("downloadCsvButton").disabled = !(rows && rows.length);
    }

    // Escape helper for safety
    function escapeHtml(s) {
      if (s === null || s === undefined) return "";
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }

    // CSV helper: quote and escape
    function csvEscapeField(v) {
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (s.includes('"')) return '"' + s.replace(/"/g, '""') + '"';
      if (s.includes(',') || s.includes('\n') || s.includes('\r')) return '"' + s + '"';
      return s;
    }

    // Download aggregated data as CSV
    function downloadCsv() {
      if (!aggregated || !aggregated.length) {
        alert("No data available to download.");
        return;
      }
      const drugQuery = $("drugQuery").value.trim() || "query";
      const startMonth = $("startMonth").value || "";
      const endMonth = $("endMonth").value || "";
      const safeQuery = drugQuery.replace(/\s+/g, '_').replace(/[^\w\-_.]/g, '');
      const filename = `epd-${safeQuery}-${startMonth}-to-${endMonth}.csv`;

      const headers = ["PRACTICE_CODE","PRACTICE_NAME","YEAR_MONTH","ITEMS","QTY","NET_COST"];
      const lines = [headers.join(',')];
      for (const r of aggregated) {
        const row = [
          csvEscapeField(r.PRACTICE_CODE),
          csvEscapeField(r.PRACTICE_NAME),
          csvEscapeField(r.YEAR_MONTH),
          csvEscapeField(Number(r.ITEMS)),
          csvEscapeField(Number(r.QTY)),
          csvEscapeField(Number(r.NET_COST).toFixed(2))
        ];
        lines.push(row.join(','));
      }
      // Add BOM so Excel recognises UTF-8
      const csvContent = '\uFEFF' + lines.join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Run query using normalized fetch wrapper ---
    async function runQuery(ev) {
      if (ev && ev.preventDefault) ev.preventDefault();

      const drugQuery = $("drugQuery").value.trim();
      const exactMatch = $("exactMatch").checked;
      const startMonth = $("startMonth").value;
      const endMonth = $("endMonth").value;
      const mode = $("searchMode").value || "presentation";

      if (!drugQuery) {
        alert("Please enter a drug name (BNF presentation).");
        return;
      }
      if (startMonth > endMonth) {
        setStatus("Start month is after end month ‚Äì please adjust the range.", { error: true });
        return;
      }

      const selectedMonths = monthsIndex.filter(m => m.yearMonth >= startMonth && m.yearMonth <= endMonth);
      if (!selectedMonths.length) {
        setStatus("No months selected ‚Äì please adjust the month range.", { error: true });
        return;
      }

      setFormEnabled(false);
      setStatus("Querying (NHSBSA CSV mode)‚Ä¶", { loading: true });
      $("resultsArea").classList.add("hidden");
      $("presentationChoice").classList.add("hidden");
      $("summaryArea").innerHTML =
        `<p class="summary-line"><strong>BNF query:</strong> <code style="font-family:${getComputedStyle(document.documentElement).getPropertyValue("--mono")}; font-size:0.9rem;">${escapeHtml(drugQuery)}</code></p>
         <p class="summary-line"><strong>Months:</strong> ${escapeHtml(startMonth)} ‚Üí ${escapeHtml(endMonth)} (${selectedMonths.length} month${selectedMonths.length > 1 ? "s" : ""})</p>`;

      rawRecords = [];
      aggregated = [];
      $("downloadCsvButton").disabled = true;
      const errors = [];

      try {
        for (const m of selectedMonths) {
          setStatus(`Fetching ${m.yearMonth}‚Ä¶`, { loading: true });
          try {
            const result = await normalizedFetchDrugDataForResource(m.resourceId, drugQuery, exactMatch, mode);
            if (result.error) errors.push({ month: m.yearMonth, resource: m.resourceId, error: result.error });
            if (result.records && result.records.length) {
              rawRecords.push(...result.records);
            }
          } catch (err) {
            const msg = err && err.message ? err.message : String(err);
            errors.push({ month: m.yearMonth, resource: m.resourceId, error: msg });
            console.error(`Request failed for ${m.resourceId}:`, msg);
          }
          // throttle a little
          await sleep(80);
        }

        if (!rawRecords.length) {
          setStatus("No rows found for that query in the selected months.", { error: true });
          $("resultsArea").classList.remove("hidden");
          renderTable([]);
          setFormEnabled(true);
          return;
        }

        aggregated = aggregateByPracticeMonth(rawRecords);
        $("resultsArea").classList.remove("hidden");
        renderTable(aggregated);

        if (errors.length) {
          setStatus(`${aggregated.length} rows aggregated. ${errors.length} month(s) failed ‚Äî see console for details.`, { error: true });
          console.warn("Month fetch errors:", errors);
        } else {
          setStatus(`${aggregated.length} rows aggregated.`);
        }
      } finally {
        setFormEnabled(true);
      }
    }

    // Lookup button (samples from most recent month)
    async function lookupBnf() {
      const q = $("drugQuery").value.trim();
      if (!q) { setStatus("Enter something to lookup.", { error: true }); return; }
      setStatus("Looking up matching presentations (NHSBSA CSV mode)‚Ä¶", { loading: true });
      setFormEnabled(false);
      const latest = monthsIndex[monthsIndex.length - 1];
      if (!latest) { setStatus("No monthly resources available to lookup.", { error: true }); setFormEnabled(true); return; }

      try {
        let res = await normalizedFetchDrugDataForResource(latest.resourceId, q, true, $("searchMode").value || "presentation");
        if ((!res.records || !res.records.length) && !res.error) {
          res = await normalizedFetchDrugDataForResource(latest.resourceId, q, false, $("searchMode").value || "presentation");
        }
        if (res.error) {
          setStatus(`Lookup failed: ${res.error}`, { error: true });
          console.warn("Lookup error:", res.error);
          return;
        }
        const names = Array.from(new Set((res.records || []).map(r => r.BNF_PRESENTATION_NAME).filter(Boolean))).sort();
        const presentationSelect = $("presentationSelect");
        presentationSelect.innerHTML = "";
        if (names.length > 1) {
          names.forEach(n => {
            const opt = document.createElement("option"); opt.value = n; opt.textContent = n;
            presentationSelect.appendChild(opt);
          });
          $("presentationChoice").classList.remove("hidden");
          presentationSelect.onchange = () => { $("drugQuery").value = presentationSelect.value; };
        } else if (names.length === 1) {
          const opt = document.createElement("option"); opt.value = names[0]; opt.textContent = names[0];
          presentationSelect.appendChild(opt);
          $("presentationChoice").classList.add("hidden");
        } else {
          $("presentationChoice").classList.add("hidden");
          setStatus("No matching presentations found.", { error: true });
        }
        setStatus("");
      } finally {
        setFormEnabled(true);
      }
    }

    // Wire UI
    document.addEventListener("DOMContentLoaded", async () => {
      initMonthsDemo();
      $("searchForm").addEventListener("submit", runQuery);
      $("lookupBnfButton").addEventListener("click", lookupBnf);
      $("downloadCsvButton").addEventListener("click", downloadCsv);
      // initial visibility: show results area empty
      $("resultsArea").classList.remove("hidden");
      $("tableContainer").innerHTML = "<p class='muted'>Run a query or use Lookup to see demo data.</p>";
    });
  </script>
</body>
</html>
