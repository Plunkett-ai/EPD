<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Prescribing Dataset (EPD) with SNOMED Code â€“ Explorer</title>
  <style>
    /* (kept original CSS from the repo; trimmed here for brevity) */
    :root { --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0; color:#111; }
    .hidden { display:none; }
    /* ...rest of your CSS... */
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>English Prescribing Dataset (EPD) with SNOMED Code â€“ Explorer</h1>
      <p>Search by BNF presentation name and view prescribing totals by practice and month, directly from the NHSBSA Open Data API.</p>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- Sidebar / Controls -->
      <section class="panel">
        <h2>
          Search parameters
          <span class="pill">Live API <span>EPD</span></span>
        </h2>

        <form id="searchForm">
          <div class="form-group">
            <label for="searchMode">Search by</label>
            <select id="searchMode" aria-label="Search mode">
              <option value="presentation">BNF presentation name</option>
              <option value="bnf_code">BNF code (BNF_CODE)</option>
            </select>
            <div class="help-text">Choose whether you're searching by presentation text or the BNF code.</div>
          </div>

          <div class="form-group">
            <label for="drugQuery">Drug name (or BNF code)</label>
            <input type="text" id="drugQuery" name="drugQuery" required autocomplete="off" value="Lorazepam 250microgram tablets" />
            <div class="help-text">Full BNF presentation text as in the dataset, e.g. <code style="font-family:var(--mono);font-size:0.75rem;">Lorazepam 250microgram tablets</code>.</div>
          </div>

          <div style="display:flex; gap:0.6rem; align-items:center;">
            <div style="flex:1;">
              <div class="inline-checkbox" style="margin:0;">
                <input type="checkbox" id="exactMatch" checked />
                <label for="exactMatch" style="margin:0;font-weight:400;">Exact match</label>
              </div>
            </div>
            <div>
              <button type="button" class="secondary" id="lookupBnfButton" title="Find matching BNF codes/presentations">ðŸ”Ž Lookup BNF codes</button>
            </div>
          </div>

          <div class="form-group">
            <label>Month range</label>
            <div style="display:flex; gap:0.4rem;">
              <div style="flex:1;">
                <select id="startMonth"></select>
                <div class="help-text">Start</div>
              </div>
              <div style="flex:1;">
                <select id="endMonth"></select>
                <div class="help-text">End</div>
              </div>
            </div>
          </div>

          <button type="submit" class="primary" id="runButton"><span>Run query</span></button>
        </form>
      </section>

      <!-- Results area (kept simplified/shortened for clarity) -->
      <section id="resultsArea" class="panel hidden">
        <h2 id="resultsTitle">Results</h2>
        <div id="resultsStats" class="help-text"></div>
        <div id="summaryArea"></div>
        <div id="presentationChoice" class="hidden">
          <label for="presentationSelect">Presentation:</label>
          <select id="presentationSelect"></select>
        </div>
        <div id="chartContainer" class="hidden">
          <canvas id="chartCanvas"></canvas>
        </div>
        <div id="tableContainer"></div>
      </section>
    </div>
  </main>

  <footer>
    <small>EPD Explorer â€” uses NHSBSA Open Data API</small>
  </footer>

  <script>
    // Minimal DOM helper
    const $ = id => document.getElementById(id);

    // State placeholders (the real file populates these from the API)
    let monthsIndex = []; // array of { yearMonth, resourceId, ... }
    let rawRecords = [];
    let aggregated = [];
    let chartInstance = null;

    // Utility: set status (stub â€” adapt to your UI implementation)
    function setStatus(msg = "", opts = {}) {
      // Implement UI status updates; for now use console and resultsStats
      if (!msg) {
        $("resultsStats").textContent = "";
        return;
      }
      $("resultsStats").textContent = msg;
      if (opts.error) console.error(msg);
      if (opts.loading) console.info(msg);
    }

    function setFormEnabled(enabled) {
      $("runButton").disabled = !enabled;
      $("lookupBnfButton").disabled = !enabled;
      $("drugQuery").disabled = !enabled;
      $("searchMode").disabled = !enabled;
      $("exactMatch").disabled = !enabled;
      $("startMonth").disabled = !enabled;
      $("endMonth").disabled = !enabled;
    }

    // Sleep helper
    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

    // --- Normalization wrapper ------------------------------------------------
    // Makes the helper tolerant of both old (Array) and new ({records, error}) shapes.
    async function normalizedFetchDrugDataForResource(resourceId, queryText, exactMatch, mode = "presentation") {
      try {
        // Call the existing helper in the page (fetchDrugDataForResource).
        // It may return:
        //  - an Array (old style): [ ...rows ]
        //  - an Object (new style): { records: [...], error: "..." }
        //  - or throw on network failure
        const res = await fetchDrugDataForResource(resourceId, queryText, exactMatch, mode);

        if (Array.isArray(res)) {
          return { records: res, error: null };
        }

        if (res && Array.isArray(res.records)) {
          return { records: res.records, error: res.error || null };
        }

        // Unknown shape but non-null: attempt to find sensible fields
        if (res && Array.isArray(res.data)) {
          return { records: res.data, error: res.error || null };
        }

        // No usable data found
        return { records: [], error: (res && res.error) || null };
      } catch (err) {
        const msg = err && err.message ? err.message : String(err);
        return { records: [], error: msg };
      }
    }

    // --- Run query (updated to use normalized wrapper) -----------------------
    async function runQuery(ev) {
      if (ev && ev.preventDefault) ev.preventDefault();

      const drugQuery = $("drugQuery").value.trim();
      const exactMatch = $("exactMatch").checked;
      const startMonth = $("startMonth").value;
      const endMonth = $("endMonth").value;
      const mode = $("searchMode").value || "presentation";

      if (!drugQuery) {
        alert("Please enter a drug name (BNF presentation).");
        return;
      }

      if (startMonth > endMonth) {
        setStatus("Start month is after end month â€“ please adjust the range.", { error: true });
        return;
      }

      const selectedMonths = monthsIndex.filter(m => m.yearMonth >= startMonth && m.yearMonth <= endMonth);

      if (!selectedMonths.length) {
        setStatus("No months selected â€“ please adjust the month range.", { error: true });
        return;
      }

      setFormEnabled(false);
      setStatus("Querying NHSBSA Open Data API for selected monthsâ€¦", { loading: true });
      $("resultsArea").classList.add("hidden");
      $("presentationChoice").classList.add("hidden");
      $("summaryArea").innerHTML =
        `<p class="summary-line"><strong>BNF query:</strong> <code style="font-family:${getComputedStyle(document.documentElement).getPropertyValue("--mono")}; font-size:0.8rem;">${drugQuery}</code></p>` +
        `<p class="summary-line"><strong>Months:</strong> ${startMonth} â†’ ${endMonth} (${selectedMonths.length} month${selectedMonths.length > 1 ? "s" : ""})</p>`;

      rawRecords = [];
      aggregated = [];
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      const errors = [];

      try {
        for (const m of selectedMonths) {
          setStatus(`Fetching ${m.yearMonth} (${m.resourceId})â€¦`, { loading: true });
          try {
            const result = await normalizedFetchDrugDataForResource(m.resourceId, drugQuery, exactMatch, mode);

            if (result.error) {
              errors.push({ month: m.yearMonth, resource: m.resourceId, error: result.error });
            }

            if (result.records && result.records.length) {
              rawRecords.push(...result.records);
            }
          } catch (outerErr) {
            const msg = outerErr && outerErr.message ? outerErr.message : String(outerErr);
            errors.push({ month: m.yearMonth, resource: m.resourceId, error: msg });
            console.error(`Request failed for ${m.resourceId}:`, msg);
          }

          // small delay to avoid hammering the API if multiple months are requested
          await sleep(200);
        }

        // Aggregate and render
        if (!rawRecords.length) {
          setStatus(
            "No rows found for that drug name in the selected months. Check the spelling or try disabling exactâ€‘match.",
            { error: true }
          );
          setFormEnabled(true);
          return;
        }

        // If your page has aggregateByPracticeMonth / renderTable etc, call them here:
        if (typeof aggregateByPracticeMonth === "function") {
          aggregated = aggregateByPracticeMonth(rawRecords);
        } else {
          aggregated = rawRecords.slice();
        }

        $("resultsArea").classList.remove("hidden");
        if (typeof renderTable === "function") renderTable(aggregated);
        if (typeof buildMetricOptions === "function") buildMetricOptions();
        if (typeof buildPracticeOptions === "function") buildPracticeOptions();
        $("chartContainer").classList.remove("hidden");
        if (typeof updateChart === "function") updateChart();

        if (errors.length) {
          setStatus(`${aggregated.length} rows aggregated. ${errors.length} month(s) failed â€” see console for details.`, { error: true });
          console.warn("Month fetch errors:", errors);
          $("resultsStats").textContent = `${aggregated.length} rows (partial â€” ${errors.length} month(s) failed)`;
        } else {
          setStatus(`${aggregated.length} rows aggregated.`);
          $("resultsStats").textContent = `${aggregated.length} rows`;
        }

      } finally {
        setFormEnabled(true);
      }
    }

    // --- Basic lookup button (updated to use normalized wrapper) ------------
    async function lookupBnf() {
      const q = $("drugQuery").value.trim();
      if (!q) {
        setStatus("Enter something to lookup.", { error: true });
        return;
      }
      setStatus("Looking up matching presentations (sample from most recent month)â€¦", { loading: true });
      setFormEnabled(false);

      const latest = monthsIndex[monthsIndex.length - 1];
      if (!latest) {
        setStatus("No monthly resources available to lookup.", { error: true });
        setFormEnabled(true);
        return;
      }

      try {
        const mode = $("searchMode").value || "presentation";

        // Try exact first, then fallback to non-exact
        let res = await normalizedFetchDrugDataForResource(latest.resourceId, q, true, mode);

        if ((!res.records || !res.records.length) && !res.error) {
          res = await normalizedFetchDrugDataForResource(latest.resourceId, q, false, mode);
        }

        if (res.error) {
          setStatus(`Lookup failed: ${res.error}`, { error: true });
          console.warn("Lookup error:", res.error);
          setFormEnabled(true);
          return;
        }

        // Populate presentationSelect from returned records
        const names = Array.from(new Set((res.records || []).map(r => r.BNF_PRESENTATION_NAME).filter(Boolean))).sort();
        const presentationSelect = $("presentationSelect");
        presentationSelect.innerHTML = "";

        if (names.length > 1) {
          names.forEach(n => {
            const opt = document.createElement("option");
            opt.value = n;
            opt.textContent = n;
            presentationSelect.appendChild(opt);
          });
          $("presentationChoice").classList.remove("hidden");
          presentationSelect.onchange = () => { /* hook up your presentation filter */ };
        } else if (names.length === 1) {
          const opt = document.createElement("option");
          opt.value = names[0];
          opt.textContent = names[0];
          presentationSelect.appendChild(opt);
          $("presentationChoice").classList.add("hidden");
        } else {
          $("presentationChoice").classList.add("hidden");
          setStatus("No matching presentations found.", { error: true });
        }

        setStatus("");
      } finally {
        setFormEnabled(true);
      }
    }

    // --- UI wiring --------------------------------------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      // initMonths should populate monthsIndex and the start/end selects
      if (typeof initMonths === "function") {
        await initMonths(); // your existing function
      } else {
        // fallback: ensure selects exist (no months)
        monthsIndex = [];
      }

      $("searchForm").addEventListener("submit", runQuery);
      $("lookupBnfButton").addEventListener("click", lookupBnf);

      // Wire other UI events if present
      const metricSelect = $("metricSelect");
      if (metricSelect) metricSelect.addEventListener("change", () => { if (typeof updateChart === "function") updateChart(); });
      const practicesSelect = $("practicesSelect");
      if (practicesSelect) practicesSelect.addEventListener("change", () => { if (typeof updateChart === "function") updateChart(); });
    });

    // NOTE:
    // - The real file contains implementations for fetchDrugDataForResource, initMonths,
    //   aggregateByPracticeMonth, renderTable, buildMetricOptions, buildPracticeOptions, updateChart, etc.
    // - This modified index.html adds a normalization wrapper to avoid the "no data" issue
    //   when fetchDrugDataForResource returns either an Array or an {records, error} object.
  </script>
</body>
</html>
