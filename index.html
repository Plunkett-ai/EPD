<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Prescribing Dataset (EPD) ‚Äî Explorer (demo)</title>
  <style>
    /* Simple responsive UI adapted from indexb.html */
    :root {
      --bg: #f4f4f7;
      --panel: #ffffff;
      --border: #dde1eb;
      --accent: #005eb8;
      --radius: 10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: var(--bg);
      color: #111827;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.35;
    }
    header {
      background: linear-gradient(135deg, var(--accent), #003f88);
      color: white;
      padding: 1rem;
    }
    .header-inner { max-width: 1100px; margin: 0 auto; }
    main { max-width: 1100px; margin: 1rem auto; padding: 0 1rem; }
    .layout { display: grid; grid-template-columns: minmax(260px, 340px) 1fr; gap: 1rem; align-items: start; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    .panel { background: var(--panel); border-radius: 10px; padding: 1rem; border: 1px solid var(--border); }
    .form-group { margin-bottom: 0.8rem; }
    label { display:block; font-weight:600; margin-bottom:0.25rem; font-size:0.95rem; }
    .help-text { color:#6b7280; font-size:0.85rem; margin-top:0.25rem; }
    input[type="text"], select { width:100%; padding:0.5rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.95rem; }
    button.primary { background:var(--accent); color:white; border:none; padding:0.55rem 0.8rem; border-radius:6px; cursor:pointer; }
    button.secondary { background:#eef5ff; color:var(--accent); border:1px solid rgba(0,94,184,0.12); padding:0.4rem 0.6rem; border-radius:6px; cursor:pointer; }
    .inline-checkbox { display:flex; align-items:center; gap:0.4rem; }
    .hidden { display:none; }
    #resultsArea { min-height:120px; }
    table { width:100%; border-collapse:collapse; margin-top:0.6rem; font-size:0.9rem; }
    th, td { padding:0.45rem 0.6rem; border-bottom:1px solid #eef2f7; text-align:left; }
    th { background:#fbfdff; font-weight:700; }
    .summary-line { margin:0.25rem 0; font-size:0.95rem; }
    footer { max-width:1100px; margin: 1rem auto; padding:0 1rem 2rem; color:#6b7280; font-size:0.85rem; }
    .muted { color:#6b7280; font-size:0.9rem; }
    .button-row { display:flex; gap:0.6rem; align-items:center; margin-top:0.6rem; }
    .spacer { flex:1; }
    .debug { font-family: var(--mono); font-size:0.85rem; color:#334155; margin-top:0.4rem; white-space:pre-wrap; background:#f8fafc; padding:0.5rem; border-radius:6px; border:1px solid #e6eef8; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1 style="margin:0;font-size:1.25rem;">English Prescribing Dataset (EPD) ‚Äî Explorer (demo)</h1>
      <p style="margin:0.4rem 0 0;" class="muted">Demo copy ‚Äî this page contains a local mock fetch implementation so it can run standalone. Replace the mock fetch with your NHSBSA/Open Data API call.</p>
    </div>
  </header>

  <main>
    <div class="layout">
      <section class="panel" aria-labelledby="search-heading">
        <h2 id="search-heading">Search parameters</h2>

        <form id="searchForm">
          <div class="form-group">
            <label for="searchMode">Search by</label>
            <select id="searchMode" aria-label="Search mode">
              <option value="presentation">BNF presentation name</option>
              <option value="bnf_code">BNF code (BNF_CODE)</option>
            </select>
            <div class="help-text">Choose whether you're searching by presentation text or the BNF code.</div>
          </div>

          <div class="form-group">
            <label for="drugQuery">Drug name (or BNF code)</label>
            <input type="text" id="drugQuery" name="drugQuery" required autocomplete="off" value="Lorazepam 250microgram tablets" />
            <div class="help-text">Full BNF presentation text as in the dataset, e.g. <code style="font-family:var(--mono);font-size:0.85rem;">Lorazepam 250microgram tablets</code>.</div>
          </div>

          <div style="display:flex; gap:0.6rem; align-items:center; margin-bottom:0.8rem;">
            <div style="flex:1;">
              <div class="inline-checkbox" style="margin:0;">
                <input type="checkbox" id="exactMatch" checked />
                <label for="exactMatch" style="margin:0;font-weight:400;">Exact match</label>
              </div>
            </div>
            <div>
              <button type="button" class="secondary" id="lookupBnfButton" title="Find matching BNF codes/presentations">üîé Lookup</button>
            </div>
          </div>

          <div class="form-group">
            <label>Month range</label>
            <div style="display:flex; gap:0.4rem;">
              <div style="flex:1;">
                <select id="startMonth"></select>
                <div class="help-text">Start</div>
              </div>
              <div style="flex:1;">
                <select id="endMonth"></select>
                <div class="help-text">End</div>
              </div>
            </div>
          </div>

          <div class="button-row">
            <button type="submit" class="primary" id="runButton"><span>Run query</span></button>
            <button type="button" class="secondary" id="downloadCsvButton" title="Download aggregated results as CSV" disabled>‚¨áÔ∏è Download CSV</button>
            <div class="spacer"></div>
            <small class="muted">Download CSV will export the aggregated practice-month rows shown in the table.</small>
          </div>
        </form>
      </section>

      <section id="resultsArea" class="panel hidden" aria-live="polite">
        <h2 id="resultsTitle">Results</h2>
        <div id="resultsStats" class="help-text"></div>
        <div id="summaryArea"></div>

        <div id="presentationChoice" class="hidden" style="margin-top:0.6rem;">
          <label for="presentationSelect">Presentation:</label>
          <select id="presentationSelect"></select>
        </div>

        <div id="tableContainer"></div>

        <div id="debugArea" class="debug hidden" aria-hidden="true"></div>
      </section>
    </div>
  </main>

  <footer>
    <small>EPD Explorer ‚Äî demo page. Replace the mock fetch implementation with your real fetchDrugDataForResource to use NHSBSA Open Data.</small>
  </footer>

  <script>
    // Minimal DOM helper
    const $ = id => document.getElementById(id);

    // State
    let monthsIndex = []; // array of { yearMonth, resourceId }
    let rawRecords = [];
    let aggregated = [];

    // Utilities
    function setStatus(msg = "", opts = {}) {
      $("resultsStats").textContent = msg || "";
      if (opts.error) console.error(msg);
      if (opts.loading) console.info(msg);
    }
    function setFormEnabled(enabled) {
      $("runButton").disabled = !enabled;
      $("lookupBnfButton").disabled = !enabled;
      $("drugQuery").disabled = !enabled;
      $("searchMode").disabled = !enabled;
      $("exactMatch").disabled = !enabled;
      $("startMonth").disabled = !enabled;
      $("endMonth").disabled = !enabled;
      // during queries this may be disabled; otherwise enable/disable based on whether there is data
      if (!enabled) {
        $("downloadCsvButton").disabled = true;
      } else {
        $("downloadCsvButton").disabled = !(aggregated && aggregated.length);
      }
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    // --- Mock / demo implementations ---
    // initMonths: populate last 18 months as demo
    function initMonthsDemo() {
      const now = new Date();
      const months = [];
      for (let i = 0; i < 18; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const ym = d.toISOString().slice(0,7); // YYYY-MM
        months.push({ yearMonth: ym, resourceId: `demo-${ym.replace('-','')}` });
      }
      monthsIndex = months.reverse(); // ascending
      const startSel = $("startMonth");
      const endSel = $("endMonth");
      startSel.innerHTML = "";
      endSel.innerHTML = "";
      monthsIndex.forEach(m => {
        const o1 = document.createElement("option");
        o1.value = m.yearMonth; o1.textContent = m.yearMonth;
        startSel.appendChild(o1);
        const o2 = document.createElement("option");
        o2.value = m.yearMonth; o2.textContent = m.yearMonth;
        endSel.appendChild(o2);
      });
      // default: last 6 months
      if (monthsIndex.length) {
        startSel.value = monthsIndex[Math.max(0, monthsIndex.length - 6)].yearMonth;
        endSel.value = monthsIndex[monthsIndex.length - 1].yearMonth;
      }
    }

    // mock fetchDrugDataForResource: returns fake rows for the resource (month)
    // Signature matches the real helper the site expects.
    async function fetchDrugDataForResource(resourceId, queryText, exactMatch = true, mode = "presentation") {
      // Simulate network delay
      await sleep(120);
      // Very small demo dataset generator
      const ym = resourceId.includes('demo-') ? `${resourceId.slice(5,9)}-${resourceId.slice(9,11)}` : resourceId;
      const baseNames = [
        "Lorazepam 250microgram tablets",
        "Lorazepam 500microgram tablets",
        "Diazepam 2mg tablets",
        "Drospirenone 3mg tablets" // added example
      ];
      // If user searched for BNF code mode we'll just pretend no data
      const q = (queryText || "").toLowerCase();
      const matches = baseNames.filter(n => {
        if (exactMatch) return n.toLowerCase() === q;
        return n.toLowerCase().includes(q);
      });

      // If nothing matches, return empty array
      if (!matches.length) return [];

      // Produce a handful of rows per matching presentation for demo
      const practices = [
        { code: "A10001", name: "Springfield Surgery" },
        { code: "A10002", name: "Riverside Medical" },
        { code: "A10003", name: "Hilltop Clinic" }
      ];

      const rows = [];
      for (const p of practices) {
        for (const name of matches) {
          // small pseudo-random but stable-ish values derived from strings
          const seed = (name.length + p.code.length + ym.length) % 10;
          const items = 10 + seed * 7;
          const qty = items * (1 + (seed % 3));
          const net = Number((items * (1.25 + (seed * 0.12))).toFixed(2));
          rows.push({
            PRACTICE_CODE: p.code,
            PRACTICE_NAME: p.name,
            BNF_PRESENTATION_NAME: name,
            ITEMS: items,
            QTY: qty,
            NET_COST: net,
            YEAR_MONTH: ym
          });
        }
      }
      return rows;
    }

    // Normalization wrapper (handles Array or {records, error})
    async function normalizedFetchDrugDataForResource(resourceId, queryText, exactMatch, mode = "presentation") {
      try {
        const res = await fetchDrugDataForResource(resourceId, queryText, exactMatch, mode);
        // DEBUG: log the raw response so users can see the shape
        console.debug("[normalizedFetch] resource:", resourceId, "query:", queryText, "exact:", exactMatch, "mode:", mode, "rawResponse:", res);

        if (Array.isArray(res)) {
          return { records: res, error: null, _raw: res };
        }
        // common shapes
        if (res && Array.isArray(res.records)) return { records: res.records, error: res.error || null, _raw: res };
        if (res && Array.isArray(res.data)) return { records: res.data, error: res.error || null, _raw: res };
        if (res && Array.isArray(res.results)) return { records: res.results, error: res.error || null, _raw: res };
        if (res && Array.isArray(res.items)) return { records: res.items, error: res.error || null, _raw: res };
        // If it's an object with a single array property, try to find it
        if (res && typeof res === "object") {
          const arrProp = Object.keys(res).find(k => Array.isArray(res[k]));
          if (arrProp) return { records: res[arrProp], error: res.error || null, _raw: res, inferredFrom: arrProp };
        }
        return { records: [], error: (res && res.error) || null, _raw: res };
      } catch (err) {
        console.error("[normalizedFetch] exception for", resourceId, err);
        return { records: [], error: err && err.message ? err.message : String(err) };
      }
    }

    // Aggregate by practice + month
    function aggregateByPracticeMonth(records) {
      const map = new Map();
      for (const r of records) {
        const key = `${r.PRACTICE_CODE}||${r.YEAR_MONTH}`;
        const existing = map.get(key) || {
          PRACTICE_CODE: r.PRACTICE_CODE,
          PRACTICE_NAME: r.PRACTICE_NAME || "",
          YEAR_MONTH: r.YEAR_MONTH,
          ITEMS: 0, QTY: 0, NET_COST: 0
        };
        existing.ITEMS += Number(r.ITEMS || 0);
        existing.QTY += Number(r.QTY || 0);
        existing.NET_COST += Number(r.NET_COST || 0);
        map.set(key, existing);
      }
      return Array.from(map.values()).sort((a,b) => {
        if (a.PRACTICE_NAME < b.PRACTICE_NAME) return -1;
        if (a.PRACTICE_NAME > b.PRACTICE_NAME) return 1;
        return a.YEAR_MONTH.localeCompare(b.YEAR_MONTH);
      });
    }

    // Render table
    function renderTable(rows) {
      const container = $("tableContainer");
      if (!rows || !rows.length) {
        container.innerHTML = "<p class='muted'>No rows to display.</p>";
        $("downloadCsvButton").disabled = true;
        return;
      }
      let html = `<div class="help-text summary-line"><strong>Showing ${rows.length} aggregated rows</strong></div>`;
      html += `<table aria-describedby="resultsTitle"><thead><tr><th>Practice</th><th>Month</th><th style="text-align:right">Items</th><th style="text-align:right">Qty</th><th style="text-align:right">Net cost</th></tr></thead><tbody>`;
      for (const r of rows) {
        html += `<tr>
          <td>${escapeHtml(r.PRACTICE_NAME)} <small class="muted">(${escapeHtml(r.PRACTICE_CODE)})</small></td>
          <td>${escapeHtml(r.YEAR_MONTH)}</td>
          <td style="text-align:right">${Number(r.ITEMS).toLocaleString()}</td>
          <td style="text-align:right">${Number(r.QTY).toLocaleString()}</td>
          <td style="text-align:right">¬£${Number(r.NET_COST).toFixed(2)}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      container.innerHTML = html;
      // enable download if there's data
      $("downloadCsvButton").disabled = !(rows && rows.length);
    }

    // Escape helper for safety
    function escapeHtml(s) {
      if (s === null || s === undefined) return "";
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }

    // CSV helper: quote and escape
    function csvEscapeField(v) {
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (s.includes('"')) return '"' + s.replace(/"/g, '""') + '"';
      if (s.includes(',') || s.includes('\n') || s.includes('\r')) return '"' + s + '"';
      return s;
    }

    // Download aggregated data as CSV
    function downloadCsv() {
      if (!aggregated || !aggregated.length) {
        alert("No data available to download.");
        return;
      }
      const drugQuery = $("drugQuery").value.trim() || "query";
      const startMonth = $("startMonth").value || "";
      const endMonth = $("endMonth").value || "";
      const safeQuery = drugQuery.replace(/\s+/g, '_').replace(/[^\w\-_.]/g, '');
      const filename = `epd-${safeQuery}-${startMonth}-to-${endMonth}.csv`;

      const headers = ["PRACTICE_CODE","PRACTICE_NAME","YEAR_MONTH","ITEMS","QTY","NET_COST"];
      const lines = [headers.join(',')];
      for (const r of aggregated) {
        const row = [
          csvEscapeField(r.PRACTICE_CODE),
          csvEscapeField(r.PRACTICE_NAME),
          csvEscapeField(r.YEAR_MONTH),
          csvEscapeField(Number(r.ITEMS)),
          csvEscapeField(Number(r.QTY)),
          csvEscapeField(Number(r.NET_COST).toFixed(2))
        ];
        lines.push(row.join(','));
      }
      // Add BOM so Excel recognises UTF-8
      const csvContent = '\uFEFF' + lines.join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Run query using normalized fetch wrapper ---
    async function runQuery(ev) {
      if (ev && ev.preventDefault) ev.preventDefault();

      const drugQuery = $("drugQuery").value.trim();
      const exactMatch = $("exactMatch").checked;
      const startMonth = $("startMonth").value;
      const endMonth = $("endMonth").value;
      const mode = $("searchMode").value || "presentation";

      if (!drugQuery) {
        alert("Please enter a drug name (BNF presentation).");
        return;
      }
      if (startMonth > endMonth) {
        setStatus("Start month is after end month ‚Äì please adjust the range.", { error: true });
        return;
      }

      const selectedMonths = monthsIndex.filter(m => m.yearMonth >= startMonth && m.yearMonth <= endMonth);
      if (!selectedMonths.length) {
        setStatus("No months selected ‚Äì please adjust the month range.", { error: true });
        return;
      }

      setFormEnabled(false);
      setStatus("Querying (demo mode)‚Ä¶", { loading: true });
      $("resultsArea").classList.add("hidden");
      $("presentationChoice").classList.add("hidden");

      // summary header
      $("summaryArea").innerHTML =
        `<p class="summary-line"><strong>BNF query:</strong> <code style="font-family:${getComputedStyle(document.documentElement).getPropertyValue("--mono")}; font-size:0.9rem;">${escapeHtml(drugQuery)}</code></p>
         <p class="summary-line"><strong>Months:</strong> ${escapeHtml(startMonth)} ‚Üí ${escapeHtml(endMonth)} (${selectedMonths.length} month${selectedMonths.length > 1 ? "s" : ""})</p>`;

      rawRecords = [];
      aggregated = [];
      $("downloadCsvButton").disabled = true;
      const errors = [];
      const fetchReport = []; // debug: { month, resource, count, error, inferredFrom }

      try {
        for (const m of selectedMonths) {
          setStatus(`Fetching ${m.yearMonth}‚Ä¶`, { loading: true });
          try {
            const result = await normalizedFetchDrugDataForResource(m.resourceId, drugQuery, exactMatch, mode);
            // record debug info
            fetchReport.push({
              month: m.yearMonth,
              resource: m.resourceId,
              count: (result.records || []).length,
              error: result.error || null,
              inferredFrom: result.inferredFrom || null,
              _raw: result._raw
            });

            if (result.error) errors.push({ month: m.yearMonth, resource: m.resourceId, error: result.error });
            if (result.records && result.records.length) {
              rawRecords.push(...result.records);
            }
          } catch (err) {
            const msg = err && err.message ? err.message : String(err);
            errors.push({ month: m.yearMonth, resource: m.resourceId, error: msg });
            fetchReport.push({ month: m.yearMonth, resource: m.resourceId, count: 0, error: msg });
            console.error(`Request failed for ${m.resourceId}:`, msg);
          }
          // throttle a little
          await sleep(80);
        }

        // show debug summary of fetches in the UI for quick inspection
        const dbg = fetchReport.map(fr => {
          const errText = fr.error ? ` ERROR: ${fr.error}` : "";
          const inferred = fr.inferredFrom ? ` (inferred:${fr.inferredFrom})` : "";
          return `${fr.month}: ${fr.count} rows${inferred}${errText}`;
        }).join('\n');
        $("debugArea").textContent = dbg;
        $("debugArea").classList.remove("hidden");
        console.debug("[runQuery] per-month fetch report:", fetchReport);

        if (!rawRecords.length) {
          setStatus("No rows found for that query in the selected months.", { error: true });
          $("resultsArea").classList.remove("hidden");
          renderTable([]);
          setFormEnabled(true);
          return;
        }

        aggregated = aggregateByPracticeMonth(rawRecords);
        $("resultsArea").classList.remove("hidden");
        renderTable(aggregated);

        if (errors.length) {
          setStatus(`${aggregated.length} rows aggregated. ${errors.length} month(s) failed ‚Äî see console for details.`, { error: true });
          console.warn("Month fetch errors:", errors);
        } else {
          setStatus(`${aggregated.length} rows aggregated.`);
        }
      } finally {
        setFormEnabled(true);
      }
    }

    // Lookup button (samples from most recent month)
    async function lookupBnf() {
      const q = $("drugQuery").value.trim();
      if (!q) { setStatus("Enter something to lookup.", { error: true }); return; }
      setStatus("Looking up matching presentations (demo)‚Ä¶", { loading: true });
      setFormEnabled(false);
      const latest = monthsIndex[monthsIndex.length - 1];
      if (!latest) { setStatus("No monthly resources available to lookup.", { error: true }); setFormEnabled(true); return; }

      try {
        let res = await normalizedFetchDrugDataForResource(latest.resourceId, q, true, $("searchMode").value || "presentation");
        // if exact match returned nothing try contains
        if ((!res.records || !res.records.length) && !res.error) {
          res = await normalizedFetchDrugDataForResource(latest.resourceId, q, false, $("searchMode").value || "presentation");
        }

        // DEBUG: show raw lookup response in console and UI debug area
        console.debug("[lookupBnf] raw lookup result:", res);
        $("debugArea").textContent = `lookup(${latest.yearMonth}): ${ (res && res.records) ? (res.records.length + " rows") : "0 rows" }` + (res && res.inferredFrom ? `, inferred from: ${res.inferredFrom}` : "");
        $("debugArea").classList.remove("hidden");

        if (res.error) {
          setStatus(`Lookup failed: ${res.error}`, { error: true });
          console.warn("Lookup error:", res.error);
          return;
        }
        const names = Array.from(new Set((res.records || []).map(r => r.BNF_PRESENTATION_NAME).filter(Boolean))).sort();
        const presentationSelect = $("presentationSelect");
        presentationSelect.innerHTML = "";
        if (names.length > 1) {
          names.forEach(n => {
            const opt = document.createElement("option"); opt.value = n; opt.textContent = n;
            presentationSelect.appendChild(opt);
          });
          $("presentationChoice").classList.remove("hidden");
          presentationSelect.onchange = () => { $("drugQuery").value = presentationSelect.value; };
        } else if (names.length === 1) {
          const opt = document.createElement("option"); opt.value = names[0]; opt.textContent = names[0];
          presentationSelect.appendChild(opt);
          $("presentationChoice").classList.add("hidden");
          // set the query to the single found presentation so user can run immediately
          $("drugQuery").value = names[0];
        } else {
          $("presentationChoice").classList.add("hidden");
          setStatus("No matching presentations found.", { error: true });
        }
        setStatus("");
      } finally {
        setFormEnabled(true);
      }
    }

    // Wire UI
    document.addEventListener("DOMContentLoaded", async () => {
      initMonthsDemo();
      $("searchForm").addEventListener("submit", runQuery);
      $("lookupBnfButton").addEventListener("click", lookupBnf);
      $("downloadCsvButton").addEventListener("click", downloadCsv);
      // initial visibility: show results area empty
      $("resultsArea").classList.remove("hidden");
      $("tableContainer").innerHTML = "<p class='muted'>Run a query or use Lookup to see demo data.</p>";
    });
  </script>
</body>
</html>
